import { Role, User } from "../../entities/User";
import { createUserProfile } from "../UserResolver";
import UserResolver from "../UserResolver";
import argon2 from "argon2";
import { Context } from "../../types/Context";
import * as jwt from "jsonwebtoken";

// Mock dependencies
jest.mock("argon2");
jest.mock("jsonwebtoken");

describe("UserResolver - Authentication Tests", () => {
  // mock graphql context (req, res etc) and resolver
  let mockContext: Context;
  let resolver: UserResolver;
  //save env to restore after tests
  const OLD_ENV = process.env;

  beforeEach(() => {
    jest.resetModules();
    process.env = { ...OLD_ENV, JWT_SECRET: "test-secret-key" };

    mockContext = {
      res: {
        //jest.fn : to mock functions, initialize empty function
        setHeader: jest.fn(),
      },
    } as unknown as Context;

    resolver = new UserResolver();

    // Clear all mocks
    jest.clearAllMocks();
  });

  //after testing setting back the env
  afterAll(() => {
    process.env = OLD_ENV;
  });

  describe("createUserProfile", () => {
    it("should create a valid user profile with USER role", () => {
      const mockUser = {
        id: 1,
        email: "test@example.com",
        username: "test",
        roles: [Role.USER],
        hashedPassword: "hashedPassword123",
      } as User;

      const result = createUserProfile(mockUser);

      expect(result).toEqual({
        id: 1,
        roles: [Role.USER],
      });
    });

    describe("signup", () => {
      it("should successfully create a new user with hashed password", async () => {
        const signupData = {
          email: "newuser@test.com",
          password: "password123",
        };

        const hashedPassword = "hashed_password_123";

        // argon2.hash : La vraie fonction de hachage d'argon2
        // as jest.Mock : Cast TypeScript pour dire à TS que c'est un mock Jest
        // .mockResolvedValue(hashedPassword) : Configure le mock pour retourner une Promise résolue avec "hashed_password_123"
        (argon2.hash as jest.Mock).mockResolvedValue(hashedPassword);
        // mockResolvedValue : pour fonctions async qui retournent une Promise
        // mockReturnValue : pour fonctions synchrones qui retournent directement
        (jwt.sign as jest.Mock).mockReturnValue("mock-jwt-token");

        const mockSave = jest.fn().mockResolvedValue(undefined);
        const mockUser = {
          id: 1,
          email: signupData.email,
          username: "newuser",
          roles: [Role.USER],
          hashedPassword,
          save: mockSave,
        };

        //Intercepte User.create
        jest.spyOn(User, "create").mockReturnValue(mockUser as any);

        const result = await resolver.signup(signupData, mockContext);

        expect(argon2.hash).toHaveBeenCalledWith("password123");
        expect(User.create).toHaveBeenCalledWith({
          email: "newuser@test.com",
          password: "password123",
          hashedPassword,
          username: "newuser",
        });
        expect(mockSave).toHaveBeenCalled();
        expect(mockContext.res.setHeader).toHaveBeenCalledWith(
          "Set-Cookie",
          expect.stringContaining("tgc-auth=")
        );

        const parsedResult = JSON.parse(result);
        expect(parsedResult).toEqual({
          email: "newuser@test.com",
          roles: [Role.USER],
          username: "newuser",
        });
      });

      it("should set secure HTTP-only cookie", async () => {
        // Arrange
        const signupData = {
          email: "user@test.com",
          password: "pass123",
        };

        (argon2.hash as jest.Mock).mockResolvedValue("hashed");
        (jwt.sign as jest.Mock).mockReturnValue("jwt-token-123");

        const mockUser = {
          id: 1,
          email: signupData.email,
          username: "user",
          roles: [Role.USER],
          save: jest.fn().mockResolvedValue(undefined),
        };

        jest.spyOn(User, "create").mockReturnValue(mockUser as any);

        // Act
        await resolver.signup(signupData, mockContext);

        // Assert
        expect(mockContext.res.setHeader).toHaveBeenCalledWith(
          "Set-Cookie",
          "tgc-auth=jwt-token-123;secure;httpOnly;SameSite=Strict;"
        );
      });
    });
  });
});
